var AccountFactory=function(n,t,i){var r={},u="Account/";return r.autoLogIn=function(r){t.readFile(LOCAL_FILE_ACCOUNT_FOLDER+"/"+LOCAL_FILE_ACCOUNT_DATA,function(t){if(t){var f=JSON.parse(t);n.sendRequestToServer({url:u+"AutoLogIn",data:{objAccount:f},callback:r})}else i.go("app.login")})},r},DeviceFactory,LoginFactory,ProfileFactory,SystemFactory,LocalStorageFactory,ErrorLogFactory,LocalFileFactory,PopupFactory,HTTPFactory,CameraFactory;AccountFactory.$inject=["HTTPFactory","LocalFileFactory","$state"];DeviceFactory=function(n,t,i,r,u,f,e,o){var s={};s.backButtonCount=0;var h=function(){if(window.device){n.global.device={};n.global.device.UUID=window.device.uuid;n.global.device.PlatformVersion=window.device.platform;n.global.device.IMEI=window.device.imei;n.global.device.DeviceName=window.device.marketingname;n.global.device.Model=window.device.model;n.global.device.Manufacturer=window.device.manufacturer;switch(window.device.platform.toLowerCase()){case"ios":n.global.device.PlatformID=1;break;case"android":n.global.device.PlatformID=2}cordova.getAppVersion(function(t){n.global.device.AppVersion=t});n.global.localFilePath="";n.global.device.PlatformID==1&&(n.global.localFilePath="NoCloud/");n.global.localFilePath+="PGApp"}},c=function(){e.checkAndUpdateScriptAndApp(function(){})},l=function(){n.global.currentLocation=="app/login"&&navigator.app.exitApp();++s.backButtonCount;r(function(){s.backButtonCount=0},3e3);s.backButtonCount==2?o.confirm("Bạn có chắc muốn đóng ứng dụng?",function(n){n?navigator.app.exitApp():s.backButtonCount=0}):u.cameraMode?u.cameraMode=!1:navigator.app.backHistory()},a=function(){n.global.isOnline=!1},v=function(){n.global.isOnline=!0},y=function(){document.addEventListener("resume",c,!1);document.addEventListener("offline",a,!1);document.addEventListener("online",v,!1);document.addEventListener("backbutton",l,!1)},p=function(){n.global.isInitialising=!0;e.checkAndUpdateApp(function(t){navigator.splashscreen.hide();t||(y(),h(),navigator.connection.type!=Connection.UNKNOWN&&navigator.connection.type!=Connection.NONE&&(n.global.isOnline=!0),f.autoLogIn(function(t){t?(e.loginSuccess(t),i.go("app.home")):i.go("app.login");n.global.isInitialising=!1}))})};return s.initialise=function(){document.addEventListener("deviceready",p,!1)},s};DeviceFactory.$inject=["$rootScope","$ionicPopup","$state","$timeout","CameraFactory","AccountFactory","SystemFactory","PopupFactory"];LoginFactory=function(n){var t={},i="Login/";return t.logOut=function(t){n.sendRequestToServer({url:i+"LogOut",callback:t})},t.getPGGroupList=function(t){n.sendRequestToServer({url:i+"GetPGGroupList",callback:t})},t.logIn=function(t,r,u){n.sendRequestToServer({url:i+"ManualLogIn",data:{strUserName:t,strPassword:r},callback:u,noAlert:!0})},t};LoginFactory.$inject=["HTTPFactory"];ProfileFactory=function(n){var t={},i="Profile/";return t.changeAvatar=function(t,r){n.sendRequestToServer({url:i+"ChangeAvatar",data:{strImageData:t},callback:r})},t.rotate=function(t,r){n.sendRequestToServer({url:i+"Rotate",data:{intType:t},callback:r})},t.setNewPassword=function(t,r,u){n.sendRequestToServer({url:i+"SetNewPassword",data:{strOldPassword:t,strNewPassword:r},callback:u})},t};ProfileFactory.$inject=["HTTPFactory"];SystemFactory=function(n,t,i,r,u,f,e){var o={},s="System/",h=function(t){n.global.isLoadingMenu||(n.global.isLoadingMenu=!0,r.sendRequestToServer({url:s+"GetMenuList",callback:function(i){i&&(n.global.menuList=i);n.global.isLoadingMenu=!1;t(i)}}))},y=function(t){n.global.device&&r.sendRequestToServer({url:s+"SaveDeviceInfo",data:{objDevice:n.global.device},callback:t})},p=function(t){var i=JSON.stringify(n.global.account);f.createFile(LOCAL_FILE_ACCOUNT_FOLDER,LOCAL_FILE_ACCOUNT_DATA,i,t)},c=function(n,t){var r=e.getObject(LOCAL_STORAGE_ALL_BUNDLE),i;r&&!t?n(r):(i=new XMLHttpRequest,i.onreadystatechange=function(){this.readyState==4&&this.status==200?n(JSON.parse(this.responseText)):n([])},i.open("GET","version.txt?v="+(new Date).getSeconds(),!0),i.send())},l=function(n){r.sendRequestToServer({url:s+"SetNewBundleVersions",data:{arrBundleVersion:n},callback:function(n){n&&(window.location=URL_PGAPP_WEB)}})},a=function(t){n.global.allBundleVersion=t;e.setObject(LOCAL_STORAGE_ALL_BUNDLE,n.global.allBundleVersion)},w=function(t){c(function(i){var r,f,e,u,o;if(i){for(a(i),r=0;r<i.length;++r){for(f=i[r],e=!1,u=0;u<n.global.allBundleVersion.length;++u)if(o=n.global.allBundleVersion[u],o.Bundle==f.Bundle){if(o.Version<f.Version){l(i);t(!0);return}e=!0;break}if(!e){l(i);t(!0);return}}t(!1)}t(!1)},!0)},b=function(n){window.plugins.webintent.startActivity({action:window.plugins.webintent.ACTION_VIEW,url:n.toURL(),type:"application/vnd.android.package-archive"},function(){},function(){});navigator.app.exitApp()},k=function(){var r=URL_INSTALL_FILE_PATH+"android/"+INSTALL_FILE_NAME+".apk",i=new FileTransfer;i.onprogress=function(t){t.lengthComputable?n.global.downloadProgress=Math.round(t.loaded*100/t.total):n.downloadProgress<100&&(n.global.downloadProgress=$scope.uploadPercent+1)};n.global.isUpdatingApp=!0;t.go("app.updateapp");i.download(encodeURI(r),"cdvfile://localhost/persistent/mwg/apk/mwg.apk",function(n){b(n)},function(n){u.addErrorLog("Lỗi tải file APK",n,"updateAndroid","SystemFactory")},!0)},d=function(){n.global.installGuideURL=URL_INSTALL_GUIDE+n.global.device.PlatformID+".jpg";switch(n.global.device.PlatformID){case 1:var t="itms-services://?action=download-manifest&url="+URL_INSTALL_FILE_PATH+"ios/"+INSTALL_FILE_NAME+".plist";window.open(t,"_system");break;case 2:k()}},v=function(n){r.sendRequestToServer({url:s+"GetAppVersion",callback:function(t){if(t){var r=String(t).substring(1);r=S(r).replaceAll(".","");cordova.getAppVersion(function(t){i(function(){var i=t.substring(1);i=S(i).replaceAll(".","");i<r?(d(),n(!0)):n(!1)})},function(t){u.addErrorLog("Lỗi lấy phiên bản app client",t,"checkAndUpdateApp","SystemFactory");n(!1)})}else n(!1)}})};return o.setScriptVersion=function(){c(function(n){n&&a()})},o.checkAndUpdateScriptAndApp=function(n){v(function(t){t||w(n)})},o.checkAndUpdateApp=function(n){v(n)},o.getMenuList=function(n){h(n)},o.loginSuccess=function(t){n.global.account=t;p(function(){});y(function(){});h(function(){})},n.$on("GetMenuList",function(){h(function(){})}),o};SystemFactory.$inject=["$rootScope","$state","$timeout","HTTPFactory","ErrorLogFactory","LocalFileFactory","LocalStorageFactory"];LocalStorageFactory=function(n){return{set:function(t,i){n.localStorage[t]=i},get:function(t,i){return n.localStorage[t]||i},setObject:function(t,i){n.localStorage[t]=JSON.stringify(i)},getObject:function(t){try{var i=n.localStorage[t];if(i)return JSON.parse(i||"{}")}catch(r){return JSON.parse("{}")}},remove:function(t){n.localStorage.removeItem(t)},clear:function(){n.localStorage.clear()}}};LocalStorageFactory.$inject=["$window"];ErrorLogFactory=function(n,t,i,r){var e={},f,u;const o=6e4;return f=function(){var n=r.getObject(LOCAL_STORAGE_ERROR_LIST);return n||(n=[]),n},u=function(){var n=f(),i;n.length>0?(r.remove(LOCAL_STORAGE_ERROR_LIST),i=JSON.stringify({arrErrorLog:n}),$.ajax({url:"ErrorLog/AddErrorLog",type:"POST",timeout:6e4,cache:!0,crossDomain:!0,contentType:"application/json; charset=utf-8;",dataType:"json",data:i,async:!0,processData:!0,beforeSend:function(){},success:function(i){if(i=="error"){var e=f();e=_.concat(e,n);r.setObject(LOCAL_STORAGE_ERROR_LIST,e);t(u,o)}},error:function(n){console.log(JSON.stringify(n));t(u,o)}})):t(u,o)},e.addErrorLog=function(t,u,e,o){var s=f(),h,c;u.message&&(u=u.message);u=JSON.stringify(u);u+="\r\n";h=new Date;u+=" ---Ngày: "+i("date")(h,"dd/MM/yyyy HH:mm:ss");c={Title:t,Content:u,Event:e,Module:o,Account:n.global.account};s.push(c);r.setObject(LOCAL_STORAGE_ERROR_LIST,s)},e.sendErrorListToServer=function(){u()},e};ErrorLogFactory.$inject=["$rootScope","$timeout","$filter","LocalStorageFactory"];LocalFileFactory=function(n,t){var r={},i=function(n,i,r){t.addErrorLog(n,i,r,"LocalFileFactory")};return r.createFile=function(t,r,u,f){try{window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){e.root.getDirectory(n.global.localFilePath,{create:!0},function(n){n.getDirectory(t,{create:!0},function(n){n.getFile(r,{create:!0},function(n){n.createWriter(function(n){n.onwrite=function(){f(!0)};n.write(u)},function(n){i("Lỗi lưu nội dung file",n,"createFile");f(!1)})},function(n){i("Lỗi load file",n,"createFile");f(!1)})},function(n){i("Lỗi load folder "+t,n,"createFile");f(null)})},function(n){i("Lỗi load folder gốc",n,"createFile");f(null)})},function(n){i("Lỗi load plugin lưu file",n,"createFile");f(!1)})}catch(e){i("Lỗi load plugin file",e,"createFile");f(!1)}},r.readFile=function(t,r){try{t=n.global.localFilePath+"/"+t;window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(n){n.root.getFile(t,null,function(n){n.file(function(n){var t=new FileReader;t.onloadend=function(n){r(n.target.result)};t.readAsText(n)},function(n){i("Lỗi đọc file",n,"createFile");r(null)})},function(n){i("Lỗi load file",n,"readFile");r(null)})},function(n){i("Lỗi load plugin đọc file",n,"readFile");r(null)})}catch(u){i("Lỗi load plugin file",u,"readFile");r(null)}},r.deleteFile=function(t,r){try{t=n.global.localFilePath+"/"+t;window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(n){n.root.getFile(t,null,function(n){n.remove(function(){r(!0)},function(n){i("Lỗi xóa file",n,"deleteFile");r(!1)})})},function(){i("Lỗi load plugin đọc file",error,"deleteFile");r(!1)})}catch(error){i("Lỗi load plugin file",error,"deleteFile");r(!1)}},r};LocalFileFactory.$inject=["$rootScope","ErrorLogFactory"];PopupFactory=function(n){var t={},i;const r=[{text:"Bỏ qua",type:"button-light",onTap:function(){return 0}},{text:"Đồng ý",type:"button-positive",onTap:function(){return 1}}];return i=function(t,i,r){var u=n.show({template:t,title:"Xác nhận",buttons:i});u.then(r)},t.getButton=function(n,t,i){return{text:n,type:"button-"+t,onTap:function(){return i}}},t.selectOption=function(n,t,r){i(n,t,r)},t.confirm=function(n,t){i(n,r,t)},t.alert=function(t,i){var r=n.alert({title:"Thông báo",template:t});r.then(function(){i&&i()})},t};PopupFactory.$inject=["$ionicPopup"];HTTPFactory=function(n,t,i,r,u,f){var e={};return e.sendRequestToServer=function(i){var h=i.timeout,o,s,e,c,l;h||(h=12e4);o=i.sync;o==null&&(o=!1);s=i.data;s||(s={});e=i.callback;e||(e=function(){});c=JSON.stringify(s);l="";t.global.account&&(l=t.global.account.Token);$.ajax({url:i.url,type:"POST",timeout:h,cache:!0,crossDomain:!0,contentType:"application/json; charset=utf-8;",dataType:"json",data:c,headers:{"Request-Origin":"PGAPP",Token:l},async:!o,processData:!0,beforeSend:function(){},success:function(t){n(function(){t.LoginError?f.alert(t.LoginError,function(){r.go("app.login")}):t.ErrorMessage?i.noAlert?e(t):f.alert(t.ErrorMessage,function(){e(null)}):t.DataTable?e(JSON.parse(t.DataTable)):t.Result?e(t.Result):e(t)})},error:function(t){n(function(){var n=t.responseText;S(n).isEmpty()&&(n=t);u.addErrorLog("Lỗi gửi request tới server","---error: "+n+" ---requestData: "+c,i.url,"HTTPFactory");f.alert("Lỗi khi kết nối tới máy chủ, vui lòng kiểm tra lại đường truyền mạng hoặc liên hê IT để được hỗ trợ!",function(){e(null)})})}})},e};HTTPFactory.$inject=["$timeout","$rootScope","$ionicPopup","$state","ErrorLogFactory","PopupFactory"];CameraFactory=function(n,t,i){var u={},r=function(n,t,r){i.addErrorLog(n,t,r)},f=function(t,i){try{var u;t==1?u=Camera.PictureSourceType.CAMERA:t==2&&(u=Camera.PictureSourceType.PHOTOLIBRARY);navigator.camera.getPicture(function(t){n(function(){i(t)})},function(n){r("Lỗi chụp hình",n,"takePhoto")},{quality:100,destinationType:Camera.DestinationType.DATA_URL,sourceType:u,encodingType:Camera.EncodingType.JPEG,targetWidth:600,targetHeight:600,saveToPhotoAlbum:!1,correctOrientation:!0})}catch(f){r("Lỗi gọi plugin chụp hình",f,"takePhoto");alert("Lỗi mở camera")}};return u.takePhoto=function(n,i){var u,e,o,s;try{i||(i=1);i==3?(u=[],e=t.getButton("Chụp hình","positive",1),u.push(e),o=t.getButton("Chọn hình","balanced",2),u.push(o),s=t.getButton("Bỏ qua","light",3),u.push(s),t.selectOption("Bạn muốn chụp hình hay chọn hình?",u,function(t){t!=3?f(t,n):n(null)})):f(i,n)}catch(h){r("Lỗi gọi plugin chụp hình",h,"takePhoto");alert("Lỗi mở camera")}},u};CameraFactory.$inject=["$timeout","PopupFactory","ErrorLogFactory"];